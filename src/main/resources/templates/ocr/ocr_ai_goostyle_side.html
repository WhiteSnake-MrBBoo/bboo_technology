<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR AI 활용 스튜디오</title>

    <link rel="icon" type="image/png" href="/images/favicon-ocr.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* =================================
           1. Google Material 3 Design Tokens (Reference Style)
           ================================= */
        :root {
            --md-sys-color-primary: #0b57d0;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #d3e3fd;
            --md-sys-color-on-primary-container: #041e49;
            --md-sys-color-background: #f0f4f9;
            --md-sys-color-surface: #ffffff;
            --md-sys-color-surface-container: #f3f6fc;
            --md-sys-color-outline: #747775;
            --md-sys-color-outline-variant: #c4c7c5;

            --border-radius-lg: 24px;
            --border-radius-md: 12px;
            --border-radius-sm: 8px;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-background);
            color: #1f1f1f;
        }

        /* Header */
        header {
            padding: 12px 24px;
            margin-bottom: 10px;
            background-color: var(--md-sys-color-surface);
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }
        .app-logo {
            font-size: 22px;
            color: #444746;
            font-weight: 400;
            display: flex;
            align-items: center;
            text-decoration: none;
        }
        .app-logo i {
            color: var(--md-sys-color-primary);
            font-size: 24px;
            margin-right: 12px;
        }

        /* Sidebar Navigation */
        .nav-google .nav-link {
            color: #444746;
            padding: 10px 16px;
            border-radius: 24px; /* Pill shape */
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            text-decoration: none;
            transition: background-color 0.2s;
        }
        .nav-google .nav-link:hover {
            background-color: #f2f2f2;
            color: #1f1f1f;
        }
        .nav-google .nav-link.active {
            background-color: #c2e7ff;
            color: #001d35;
            font-weight: 600;
        }
        .nav-google .nav-link i {
            font-size: 18px;
            width: 24px;
            margin-right: 12px;
            text-align: center;
        }
        .category-title {
            color: #1f1f1f;
            font-weight: 500;
            font-size: 16px;
            margin-bottom: 12px;
        }

        /* Google Card Style */
        .google-card {
            background-color: var(--md-sys-color-surface);
            border-radius: var(--border-radius-lg);
            padding: 24px;
            height: 100%;
            border: 1px solid var(--md-sys-color-outline-variant);
            box-shadow: none;
        }

        /* Buttons */
        .btn-google {
            border-radius: 20px;
            font-weight: 500;
            font-size: 14px;
            padding: 8px 20px;
            transition: box-shadow 0.2s;
        }
        .btn-google-primary {
            background-color: var(--md-sys-color-primary);
            color: white;
            border: none;
        }
        .btn-google-primary:hover {
            background-color: #0842a0;
            color: white;
            box-shadow: 0 1px 3px 1px rgba(0,0,0,0.15);
        }
        .btn-google-filled-tonal {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            border: none;
        }
        .btn-google-filled-tonal:hover {
            background-color: #c0d8f7;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .btn-google-text { /* For 'Go to Console' */
            background-color: transparent;
            color: var(--md-sys-color-primary);
            border: none;
            padding: 6px 12px;
        }
        .btn-google-text:hover {
            background-color: #f2f2f2;
        }

        /* Form Inputs */
        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid var(--md-sys-color-outline-variant);
            padding: 10px 14px;
            font-size: 14px;
            background-color: var(--md-sys-color-surface-container);
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--md-sys-color-primary);
            box-shadow: 0 0 0 2px rgba(11, 87, 208, 0.2);
            outline: none;
            background-color: var(--md-sys-color-surface);
        }

        /* =================================
           2. AI Studio Specific Styles (Adapted)
           ================================= */
        
        /* Document List Items */
        .ai-doc-list {
            max-height: calc(100vh - 280px);
            overflow-y: auto;
        }
        .ai-doc-item {
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            color: #1f1f1f;
            display: block;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .ai-doc-item:hover {
            background-color: #f2f2f2;
        }
        .ai-doc-item.active {
            background-color: #c2e7ff; /* Active Blue */
            color: #001d35;
            font-weight: 500;
        }
        
        /* Main Panel Textareas */
        .ai-ocr-text {
            background-color: #f0f4f9 !important; /* Readonly look */
            color: #444746;
            min-height: 150px;
            resize: vertical;
        }
        .ai-gpt-result {
            background-color: #ffffff !important;
            border: 1px solid var(--md-sys-color-outline-variant);
            min-height: 200px;
            resize: vertical;
        }

        /* Tabs */
        .nav-tabs {
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }
        .nav-tabs .nav-link {
            border: none;
            color: #444746;
            margin-right: 2px;
            border-bottom: 2px solid transparent;
            padding: 10px 16px;
        }
        .nav-tabs .nav-link:hover {
            background-color: #f2f2f2;
            color: var(--md-sys-color-primary);
        }
        .nav-tabs .nav-link.active {
            color: var(--md-sys-color-primary);
            border-bottom-color: var(--md-sys-color-primary);
            background-color: transparent;
            font-weight: 600;
        }

        /* Layout Utility */
        .ai-layout .row > div:not(.google-card) {
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }
    </style>
</head>

<body>

<header>
    <div class="d-flex justify-content-between align-items-center">
        <a class="app-logo" href="http://localhost:9001/ocr">
            <i class="fa-solid fa-brain"></i> <span>OCR AI Studio</span>
        </a>

        <div class="d-flex gap-2 align-items-center">
            <button type="button" class="btn btn-light rounded-circle" style="width: 40px; height: 40px;" disabled>
                <i class="fa-solid fa-gear text-muted"></i>
            </button>

            <button type="button"
                    class="btn btn-google-primary d-lg-none"
                    id="mobileSidebarToggle"
                    aria-controls="mobileSidebar"
                    style="width: 40px; height: 40px; padding: 0;">
                <i class="fa-solid fa-bars"></i>
            </button>

            <div class="rounded-circle bg-danger text-white d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; font-size: 14px;">
                J
            </div>
        </div>
    </div>
</header>

<div class="container-fluid ai-layout px-4">
    <div class="row g-4">

        <aside class="col-lg-2 d-none d-lg-block">
            <div class="p-3">
                <div class="category-title">TOOLS</div>
                <nav class="nav-google d-flex flex-column small">
                    <a href="http://localhost:9001/ocr" class="nav-link">
                        <i class="fa-solid fa-crop-simple"></i> OCR Studio
                    </a>
                    <a href="http://localhost:9001/ocr/ai" class="nav-link active">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> AI Converter
                    </a>
                    <a href="http://localhost:9001/ocr/ai/history" class="nav-link">
                        <i class="fa-regular fa-file-excel"></i> Ai History Excel
                    </a>
                    <a href="http://localhost:9001/api/stt/file" class="nav-link">
                        <i class="fa-solid fa-microphone"></i> [STT] Voice to Text
                    </a>
                </nav>
            </div>
        </aside>

        <main class="col-12 col-lg-10">
            <div class="row g-4">

                <div class="col-12 col-xl-4">
                    <div class="google-card p-4 h-100">
                        <div class="d-flex align-items-center mb-3">
                            <h5 class="mb-0 fw-bold fs-6 text-secondary">
                                <i class="fa-solid fa-folder-open me-2"></i>OCR Documents
                            </h5>
                        </div>

                        <form class="mb-4">
                            <div class="input-group input-group-sm mb-2">
                                <input type="text" class="form-control" placeholder="Search files...">
                                <button class="btn btn-google-filled-tonal btn-sm" type="button">
                                    <i class="fa-solid fa-search"></i>
                                </button>
                            </div>
                            <div class="d-flex gap-2">
                                <select class="form-select form-select-sm">
                                    <option>All Types</option>
                                    <option>Image</option>
                                    <option>PDF</option>
                                </select>
                                <select class="form-select form-select-sm">
                                    <option>Recent</option>
                                    <option>Oldest</option>
                                </select>
                            </div>
                        </form>

                        <div class="ai-doc-list">
                            <div th:if="${#lists.isEmpty(ocrList)}" class="text-center text-muted small p-4">
                                <i class="fa-regular fa-folder-open fa-2x mb-2 opacity-50"></i><br>
                                No saved documents found.<br>
                                Go to OCR Studio to process files.
                            </div>

                            <a th:each="item : ${ocrList}"
                               th:href="@{/ocr/ai(id=${item.id})}"
                               class="ai-doc-item"
                               th:classappend="${selectedOcr != null and item.id == selectedOcr.id} ? ' active'">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="text-truncate me-2">
                                        <div class="fw-semibold text-truncate" th:text="${item.title}">OCR Transform Title</div>
                                        <div class="small text-muted text-truncate" th:text="${item.originalFileName}">file.pdf</div>
                                    </div>
                                    <span class="badge bg-light text-dark border small" style="font-weight: 400;">PDF</span>
                                </div>
                                <div class="mt-2 small text-muted d-flex justify-content-between">
                                    <span th:text="${item.createdAt}">2024-01-01</span>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-xl-8">
                    <div class="google-card p-4 h-100">
                        
                        <input type="hidden" id="selectedOcrId" th:if="${selectedOcr != null}" th:value="${selectedOcr.id}">

                        <div class="d-flex justify-content-between align-items-start mb-4 pb-3 border-bottom">
                            <div th:if="${selectedOcr != null}">
                                <h2 class="h5 fw-bold mb-1 text-primary">
                                    <i class="fa-solid fa-file-lines me-2"></i>
                                    <span th:text="${selectedOcr.title}">Selected Document Title</span>
                                </h2>
                                <div class="small text-muted">
                                    File: <span th:text="${selectedOcr.originalFileName}">sample.pdf</span>
                                </div>
                            </div>
                            <div th:if="${selectedOcr == null}">
                                <h2 class="h5 fw-bold mb-1 text-muted">No Document Selected</h2>
                                <div class="small text-muted">Select a document from the list to start AI processing.</div>
                            </div>
                            
                            <div class="text-end">
                                <a th:href="@{/ocr}" class="btn btn-google btn-google-text btn-sm">
                                    Go to OCR Console <i class="fa-solid fa-arrow-right ms-1"></i>
                                </a>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="label-google text-muted mb-2">SOURCE OCR TEXT (READ-ONLY)</label>
                            <div th:if="${selectedOcr != null}">
                                <textarea class="form-control ai-ocr-text" readonly th:text="${selectedOcr.editedText}"></textarea>
                            </div>
                            <div th:if="${selectedOcr == null}">
                                <div class="form-control ai-ocr-text d-flex align-items-center justify-content-center text-muted">
                                    No text source loaded.
                                </div>
                            </div>
                        </div>

                        <ul class="nav nav-tabs mb-3" id="gptTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary-panel" type="button">
                                    <i class="fa-solid fa-compress-arrows-alt me-1"></i> Summary
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="host-tab" data-bs-toggle="tab" data-bs-target="#host-panel" type="button">
                                    <i class="fa-solid fa-microphone-alt me-1"></i> Host-Script
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="marketing-tab" data-bs-toggle="tab" data-bs-target="#marketing-panel" type="button">
                                    <i class="fa-solid fa-bullhorn me-1"></i> Marketing-Points
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="gptTabContent">
                            
                            <div class="tab-pane fade show active" id="summary-panel" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="label-google text-primary mb-0">AI GENERATED SUMMARY</label>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-google btn-google-primary btn-sm" id="btn-summary-generate" th:disabled="${selectedOcr == null}">
                                            <i class="fa-solid fa-wand-magic-sparkles me-1"></i> AI_SUM_Generate
                                        </button>
                                        <button class="btn btn-google btn-google-filled-tonal btn-sm" id="btn-summary-save" th:disabled="${selectedOcr == null}">
                                            <i class="fa-regular fa-floppy-disk me-1"></i> DB_Save
                                        </button>
                                    </div>
                                </div>
                                <textarea class="form-control ai-gpt-result" id="summaryResult" placeholder="AI summary will appear here..."></textarea>
                            </div>

                            <div class="tab-pane fade" id="host-panel" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="label-google text-primary mb-0">SHOW HOST SCRIPT</label>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-google btn-google-primary btn-sm" id="btn-host-generate" th:disabled="${selectedOcr == null}">
                                            <i class="fa-solid fa-wand-magic-sparkles me-1"></i> AI_SHOW_Generate
                                        </button>
                                        <button class="btn btn-google btn-google-filled-tonal btn-sm" id="btn-host-save" th:disabled="${selectedOcr == null}">
                                            <i class="fa-regular fa-floppy-disk me-1"></i> DB_Save
                                        </button>
                                    </div>
                                </div>
                                <textarea class="form-control ai-gpt-result" id="hostResult" placeholder="Host script will appear here..."></textarea>
                            </div>

                            <div class="tab-pane fade" id="marketing-panel" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="label-google text-primary mb-0">MARKETING POINTS</label>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-google btn-google-primary btn-sm" id="btn-marketing-generate" th:disabled="${selectedOcr == null}">
                                            <i class="fa-solid fa-wand-magic-sparkles me-1"></i> AI_MARKETING_Generate
                                        </button>
                                        <button class="btn btn-google btn-google-filled-tonal btn-sm" id="btn-marketing-save" th:disabled="${selectedOcr == null}">
                                            <i class="fa-regular fa-floppy-disk me-1"></i> DB_Save
                                        </button>
                                    </div>
                                </div>
                                <textarea class="form-control ai-gpt-result" id="marketingResult" placeholder="Marketing points will appear here..."></textarea>
                            </div>

                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>
</div>

<div class="offcanvas offcanvas-start" tabindex="-1" id="mobileSidebar" aria-labelledby="mobileSidebarLabel">
    <div class="offcanvas-header bg-white border-bottom">
        <h5 class="offcanvas-title fw-bold" id="mobileSidebarLabel">
            <i class="fa-solid fa-brain text-primary me-2"></i> OCR Menu
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body px-3">
        <div class="category-title">TOOLS</div>
        <nav class="nav-google d-flex flex-column small">
            <a href="http://localhost:9001/ocr" class="nav-link">
                <i class="fa-solid fa-crop-simple"></i> OCR Studio
            </a>
            <a href="http://localhost:9001/ocr/ai" class="nav-link active">
                <i class="fa-solid fa-wand-magic-sparkles"></i> AI Converter
            </a>
            <a href="http://localhost:9001/ocr/ai/history" class="nav-link">
                <i class="fa-regular fa-file-excel"></i> AI History Excel
            </a>
            <a href="http://localhost:9001/api/stt/file" class="nav-link">
                <i class="fa-solid fa-microphone"></i> [STT] Voice to Text
            </a>
        </nav>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        // ============================================
        // Mobile Sidebar Logic (Manual Toggle)
        // ============================================
        const mobileSidebarToggleBtn = document.getElementById('mobileSidebarToggle');
        const mobileSidebarEl = document.getElementById('mobileSidebar');

        if (mobileSidebarToggleBtn && mobileSidebarEl && window.bootstrap && bootstrap.Offcanvas) {
            // Initialize Offcanvas
            const mobileSidebarOffcanvas = new bootstrap.Offcanvas(mobileSidebarEl);

            // Toggle on Click
            mobileSidebarToggleBtn.addEventListener('click', function (e) {
                e.preventDefault();
                mobileSidebarOffcanvas.show();
            });

            // Close on Link Click
            const offcanvasLinks = mobileSidebarEl.querySelectorAll('.nav-link');
            offcanvasLinks.forEach(link => {
                link.addEventListener('click', () => {
                    mobileSidebarOffcanvas.hide();
                });
            });
        }

        // ============================================
        // AI Logic (Preserved)
        // ============================================
        const selectedIdInput = document.getElementById('selectedOcrId');
        let currentOcrId = selectedIdInput ? selectedIdInput.value : "";

        // Common AI Call Function
        function callAi(endpoint, textareaId) {
            const textarea = document.getElementById(textareaId);
            // Dynamic ID mapping for buttons
            let btnId = "";
            if (textareaId === "summaryResult") btnId = "btn-summary-generate";
            else if (textareaId === "hostResult") btnId = "btn-host-generate";
            else if (textareaId === "marketingResult") btnId = "btn-marketing-generate";
            
            const generateBtn = document.getElementById(btnId);

            if (!currentOcrId) {
                alert("Please select a document from the list first.");
                return;
            }
            if (!textarea) return;

            textarea.value = "Requesting AI generation...\nPlease wait.";
            if (generateBtn) {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i> Processing...';
            }

            fetch(endpoint, {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
                body: "id=" + encodeURIComponent(currentOcrId)
            })
            .then(res => res.ok ? res.json() : Promise.reject(res.status))
            .then(data => {
                if (data.success) textarea.value = data.content;
                else {
                    textarea.value = "";
                    alert(data.message || "Error during AI processing.");
                }
            })
            .catch(err => {
                console.error("AI Error:", err);
                textarea.value = "";
                alert("Communication error with AI server.");
            })
            .finally(() => {
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles me-1"></i> Generate';
                }
            });
        }

        // Bind Generate Buttons
        const btnSummary = document.getElementById("btn-summary-generate");
        if (btnSummary) btnSummary.addEventListener("click", () => callAi("/ocr/ai/summary", "summaryResult"));

        const btnHost = document.getElementById("btn-host-generate");
        if (btnHost) btnHost.addEventListener("click", () => callAi("/ocr/ai/host", "hostResult"));

        const btnMarketing = document.getElementById("btn-marketing-generate");
        if (btnMarketing) btnMarketing.addEventListener("click", () => callAi("/ocr/ai/marketing", "marketingResult"));


        // Common Save Function
        async function saveAiResult(type) {
            if (!currentOcrId) {
                alert("Please select a document first.");
                return;
            }

            let textareaId = "";
            if (type === "SUMMARY") textareaId = "summaryResult";
            else if (type === "HOST_SCRIPT") textareaId = "hostResult";
            else if (type === "MARKETING_POINTS") textareaId = "marketingResult";

            const textarea = document.getElementById(textareaId);
            if (!textarea) return;

            const content = textarea.value.trim();
            if (!content) {
                alert("Content is empty.");
                return;
            }

            // Find save button to show loading
            let saveBtnId = "";
            if (textareaId === "summaryResult") saveBtnId = "btn-summary-save";
            else if (textareaId === "hostResult") saveBtnId = "btn-host-save";
            else if (textareaId === "marketingResult") saveBtnId = "btn-marketing-save";
            
            const saveBtn = document.getElementById(saveBtnId);
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i> Saving...';
            }

            try {
                const params = new URLSearchParams();
                params.append("id", currentOcrId);
                params.append("type", type);
                params.append("content", content);

                const response = await fetch("/ocr/ai/save", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
                    body: params.toString()
                });

                if (!response.ok) throw new Error("Server Error");

                const data = await response.json();
                if (data.success) alert("Saved successfully!");
                else alert("Save failed: " + data.message);

            } catch (err) {
                console.error(err);
                alert("Error saving result.");
            } finally {
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fa-regular fa-floppy-disk me-1"></i> Save';
                }
            }
        }

        // Bind Save Buttons
        const btnSaveSummary = document.getElementById("btn-summary-save");
        if (btnSaveSummary) btnSaveSummary.addEventListener("click", () => saveAiResult("SUMMARY"));

        const btnSaveHost = document.getElementById("btn-host-save");
        if (btnSaveHost) btnSaveHost.addEventListener("click", () => saveAiResult("HOST_SCRIPT"));

        const btnSaveMarketing = document.getElementById("btn-marketing-save");
        if (btnSaveMarketing) btnSaveMarketing.addEventListener("click", () => saveAiResult("MARKETING_POINTS"));

    });
</script>

</body>
</html>